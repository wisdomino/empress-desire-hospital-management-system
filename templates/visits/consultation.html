{% extends "base.html" %}
{% block title %}Consultation | EDH{% endblock %}
{% block subtitle %}Doctor consultation — {{ visit.visit_number }}{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h4 class="mb-1">Consultation</h4>
    <div class="text-muted small">
      {{ visit.patient.last_name }} {{ visit.patient.first_name }} • {{ visit.patient.hospital_number }}
      • Visit: {{ visit.visit_number }}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" style="border-radius:12px;" href="{% url 'visits:queue' %}">← Queue</a>
    <a class="btn btn-outline-dark" style="border-radius:12px;" href="{% url 'visits:visit_detail' visit.id %}">Visit Summary</a>
    <a class="btn btn-dark" style="border-radius:12px; background:var(--brand); border:0;"
       href="{% url 'visits:close_visit' visit.id %}">
      Close Visit
    </a>
  </div>
</div>

<div class="row g-3">
  <!-- CONSULTATION FORM -->
  <div class="col-12 col-lg-7">
    <div class="card">
      <div class="card-body">
        <div class="fw-bold mb-2">Clinical Notes</div>

        <form method="post" class="row g-3">
          {% csrf_token %}

          <div class="col-12">
            <label class="form-label">Chief Complaint</label>
            {{ form.chief_complaint }}
          </div>
          <div class="col-12">
            <label class="form-label">History of Present Illness</label>
            {{ form.history_of_present_illness }}
          </div>
          <div class="col-12">
            <label class="form-label">Examination</label>
            {{ form.examination }}
          </div>

          <div class="col-md-6">
            <label class="form-label">Primary Diagnosis</label>
            {{ form.diagnosis_primary }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Secondary Diagnosis</label>
            {{ form.diagnosis_secondary }}
          </div>

          <div class="col-12">
            <label class="form-label">Treatment Plan</label>
            {{ form.treatment_plan }}
          </div>
          <div class="col-12">
            <label class="form-label">Doctor Notes</label>
            {{ form.doctor_notes }}
          </div>

          <div class="col-12">
            <button class="btn btn-primary" style="background:var(--brand2); border:0; border-radius:12px;">
              Save Consultation
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- PRESCRIPTIONS + LAB REQUESTS -->
  <div class="col-12 col-lg-5">

    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <div class="fw-bold">Prescriptions</div>
          <a class="btn btn-sm btn-outline-dark" style="border-radius:12px;" href="/pharmacy/queue/">Pharmacy Queue</a>
        </div>

        <form method="post" action="{% url 'pharmacy:add_prescription' visit.id %}" class="row g-2 mb-3">
          {% csrf_token %}
          <div class="col-12">
            <label class="form-label small text-muted mb-1">Drug</label>
            {{ prescription_form.drug }}
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Dose</label>
            {{ prescription_form.dose }}
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Frequency</label>
            {{ prescription_form.frequency }}
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Duration</label>
            {{ prescription_form.duration }}
          </div>
          <div class="col-6">
            <label class="form-label small text-muted mb-1">Instructions</label>
            {{ prescription_form.instructions }}
          </div>
          <div class="col-12">
            <button class="btn btn-dark w-100" style="border-radius:12px; background:var(--brand); border:0;">
              Add Prescription
            </button>
          </div>
        </form>        

        <div class="small text-muted mb-2">Items</div>
        <div class="d-grid gap-2">
          {% for p in prescriptions %}
            <div class="border rounded-3 p-2">
              <div class="fw-semibold">{{ p.drug }}</div>
              <div class="text-muted small">{{ p.dose }} • {{ p.frequency }} • {{ p.duration }} • {{ p.instructions }}</div>
              <div class="small">
                {% if p.status == "PENDING" %}
                  <span class="badge text-bg-warning rounded-pill">Pending</span>
                {% else %}
                  <span class="badge text-bg-success rounded-pill">{{ p.get_status_display }}</span>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="text-muted small">No prescriptions yet.</div>
          {% endfor %}
        </div>
      </div>
    </div>

<script>
  document.querySelectorAll("select").forEach(el=>el.classList.add("form-select"));
  document.querySelectorAll("input, textarea").forEach(el=>el.classList.add("form-control"));
</script>
{% endblock %}
