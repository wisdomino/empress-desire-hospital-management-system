{% extends "base.html" %}
{% load billing_extras %}
{% block title %}HMO Aging | EDH{% endblock %}
{% block subtitle %}Outstanding HMO receivables by aging bucket{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h4 class="mb-1">HMO Aging Dashboard</h4>
    <div class="text-muted small">As of {{ today }}</div>
  </div>
  <a href="{% url 'billing:dashboard' %}" class="btn btn-outline-dark" style="border-radius:12px;">
    Revenue Dashboard
  </a>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card text-center"><div class="card-body">
      <div class="text-muted small">Total Outstanding (HMO)</div>
      <div class="fw-bold fs-4 text-warning">₦{{ grand.total|floatformat:2 }}</div>
    </div></div>
  </div>

  <div class="col-md-3">
    <div class="card text-center"><div class="card-body">
      <div class="text-muted small">0–30 Days</div>
      <div class="fw-bold fs-4">₦{{ grand|getitem:"0-30"|floatformat:2 }}</div>
    </div></div>
  </div>

  <div class="col-md-3">
    <div class="card text-center"><div class="card-body">
      <div class="text-muted small">31–60 Days</div>
      <div class="fw-bold fs-4">₦{{ grand|getitem:"31-60"|floatformat:2 }}</div>
    </div></div>
  </div>

  <div class="col-md-3">
    <div class="card text-center"><div class="card-body">
      <div class="text-muted small">90+ Days</div>
      <div class="fw-bold fs-4 text-danger">₦{{ grand|getitem:"90+"|floatformat:2 }}</div>
    </div></div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-8">
    <div class="card"><div class="card-body">
      <div class="fw-bold mb-2">Top HMOs by Outstanding</div>
      <canvas id="topHmoChart"></canvas>
    </div></div>
  </div>
  <div class="col-lg-4">
    <div class="card"><div class="card-body">
      <div class="fw-bold mb-2">Aging Bucket Mix</div>
      <canvas id="bucketChart"></canvas>
    </div></div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>HMO</th>
            <th class="text-end">0–30</th>
            <th class="text-end">31–60</th>
            <th class="text-end">61–90</th>
            <th class="text-end">90+</th>
            <th class="text-end">Total</th>
            <th class="text-end"></th>
          </tr>
        </thead>
        <tbody>
        {% for h in hmo_table %}
          <tr>
            <td class="fw-semibold">{{ h.hmo_name }}</td>
            <td class="text-end">{{ h|getitem:"0-30"|floatformat:2 }}</td>
            <td class="text-end">{{ h|getitem:"31-60"|floatformat:2 }}</td>
            <td class="text-end">{{ h|getitem:"61-90"|floatformat:2 }}</td>
            <td class="text-end">{{ h|getitem:"90+"|floatformat:2 }}</td>
            <td class="text-end fw-bold">{{ h.total|floatformat:2 }}</td>

            <td class="text-end">
              <a class="btn btn-sm btn-outline-dark" style="border-radius:12px;"
                 href="{% url 'billing:hmo_reminder_pdf' h.hmo_name %}">
                Reminder PDF
              </a>
              <a class="btn btn-sm btn-outline-secondary" style="border-radius:12px;"
                 href="{% url 'billing:hmo_disputes_pdf' h.hmo_name %}">
                Disputes PDF
              </a>
              <a class="btn btn-sm btn-dark" style="border-radius:12px; background:var(--brand); border:0;"
                 href="{% url 'billing:mark_hmo_reminded' %}?hmo={{ h.hmo_name|urlencode }}">
                Mark Reminded
              </a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-5">No outstanding HMO receivables.</td></tr>
        {% endfor %}
        </tbody>
        <tfoot class="table-light">
          <tr>
            <th>Grand Total</th>
            <th class="text-end">{{ grand|getitem:"0-30"|floatformat:2 }}</th>
            <th class="text-end">{{ grand|getitem:"31-60"|floatformat:2 }}</th>
            <th class="text-end">{{ grand|getitem:"61-90"|floatformat:2 }}</th>
            <th class="text-end">{{ grand|getitem:"90+"|floatformat:2 }}</th>
            <th class="text-end fw-bold">{{ grand.total|floatformat:2 }}</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="fw-bold mb-2">Top Outstanding Invoices (Drill)</div>
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>Invoice</th>
            <th>Hospital No</th>
            <th>Patient</th>
            <th>HMO</th>
            <th class="text-end">Outstanding (₦)</th>
            <th class="text-end">Days</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
        {% for r in top_invoices %}
          <tr>
            <td class="fw-semibold">{{ r.invoice_number }}</td>
            <td class="text-muted">{{ r.hospital_number }}</td>
            <td>{{ r.patient }}</td>
            <td class="text-muted">{{ r.hmo_name }}</td>
            <td class="text-end fw-bold">{{ r.outstanding|floatformat:2 }}</td>
            <td class="text-end">{{ r.days }}</td>

            <td class="text-end">
              <a class="btn btn-sm btn-outline-dark" style="border-radius:12px;"
                 href="{% url 'billing:invoice_detail' r.invoice_id %}">
                Open
              </a>
              <a class="btn btn-sm btn-outline-danger" style="border-radius:12px;"
                 href="{% url 'billing:mark_invoice_disputed' r.invoice_id %}">
                Flag Dispute
              </a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-muted py-4">No outstanding invoices.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const topLabels = {{ chart_labels|safe }};
  const topTotals = {{ chart_totals|safe }};

  new Chart(document.getElementById("topHmoChart"), {
    type: "bar",
    data: { labels: topLabels, datasets: [{ label: "Outstanding (₦)", data: topTotals }] },
    options: { responsive: true }
  });

  const bucketLabels = {{ bucket_labels|safe }};
  const bucketTotals = {{ bucket_totals|safe }};

  new Chart(document.getElementById("bucketChart"), {
    type: "doughnut",
    data: { labels: bucketLabels, datasets: [{ data: bucketTotals }] },
    options: { responsive: true }
  });
</script>
{% endblock %}
