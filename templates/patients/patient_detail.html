{% extends "base.html" %}
{% block title %}{{ patient.hospital_number }} | EDH{% endblock %}
{% block subtitle %}Patient profile{% endblock %}

{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h4 class="mb-1">Patient Profile</h4>
    <div class="text-muted small">{{ patient.hospital_number }}</div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'patients:patient_list' %}" class="btn btn-outline-secondary" style="border-radius:12px;">
      ← Back
    </a>
    <a href="{% url 'patients:patient_create' %}" class="btn btn-primary"
       style="background:var(--brand2); border:0; border-radius:12px;">
      + New Patient
    </a>
  </div>
</div>

<div class="row g-3">

  <!-- LEFT: PROFILE SUMMARY -->
  <div class="col-12 col-lg-4">
    <div class="card">
      <div class="card-body">

        <div class="d-flex align-items-center gap-3">
          {% if patient.passport_photo %}
            <img class="avatar" src="{{ patient.passport_photo.url }}" alt="passport"
                 style="width:72px;height:72px;border-radius:14px;object-fit:cover;">
          {% else %}
            <div class="d-flex align-items-center justify-content-center text-muted"
                 style="width:72px;height:72px;border-radius:14px;background:#f3f4f6;">
              <span class="fw-bold">EDH</span>
            </div>
          {% endif %}

          <div>
            <div class="fw-bold fs-5">
              {{ patient.last_name }} {{ patient.first_name }} {{ patient.other_names }}
            </div>
            <div class="text-muted small">
              {{ patient.gender }}
              {% if patient.date_of_birth %} • DOB: {{ patient.date_of_birth }}{% endif %}
            </div>
            <div class="mt-2">
              {% if patient.is_hmo and patient.hmo %}
                <span class="badge rounded-pill" style="background:rgba(13,110,253,.12); color:#0d6efd;">
                  HMO: {{ patient.hmo.name }}
                </span>
              {% else %}
                <span class="badge text-bg-secondary rounded-pill">Private</span>
              {% endif %}
            </div>
          </div>
        </div>

        <hr>

        <div class="small text-muted">Quick Info</div>
        <div class="mt-2">
          <div class="d-flex justify-content-between">
            <span class="text-muted">Phone</span>
            <span class="fw-semibold">{{ patient.phone|default:"—" }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Email</span>
            <span class="fw-semibold">{{ patient.email|default:"—" }}</span>
          </div>
          <div class="d-flex justify-content-between">
            <span class="text-muted">Blood Group</span>
            <span class="fw-semibold">{{ patient.blood_group|default:"—" }}</span>
          </div>
        </div>

        <div class="mt-3 d-grid gap-2">
          <a class="btn btn-dark"
             style="border-radius:12px; background:var(--brand); border:0;"
             href="{% url 'visits:start_visit' patient.id %}">
            Start Visit
          </a>

          <a class="btn btn-outline-dark" style="border-radius:12px;"
             href="{% url 'visits:queue' %}">
            View Visit Queue
          </a>

          {# Emergency PDF uses most recent visit if exists #}
          <a class="btn btn-outline-secondary" style="border-radius:12px;"
             href="{% if visits and visits.0 %}{% url 'visits:emergency_pdf' visits.0.id %}{% else %}#{% endif %}">
            Emergency Summary PDF
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- RIGHT: FULL DETAILS + HISTORY -->
  <div class="col-12 col-lg-8">

    <!-- ADDRESS -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="fw-bold mb-2">Address</div>
        <div class="text-muted">{{ patient.address|default:"—" }}</div>
      </div>
    </div>

    <!-- HMO DETAILS -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="fw-bold mb-2">HMO Details</div>
        <div class="row g-2">
          <div class="col-12 col-md-4">
            <div class="text-muted small">Under HMO?</div>
            <div class="fw-semibold">{% if patient.is_hmo %}Yes{% else %}No{% endif %}</div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-muted small">HMO Provider</div>
            <div class="fw-semibold">
              {% if patient.is_hmo and patient.hmo %}{{ patient.hmo.name }}{% else %}—{% endif %}
            </div>
          </div>
          <div class="col-12 col-md-4">
            <div class="text-muted small">HMO ID</div>
            <div class="fw-semibold">{{ patient.hmo_id_number|default:"—" }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- EMERGENCY NOTES -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="fw-bold mb-2">Emergency Notes</div>
        <div class="text-muted small">Allergies / Chronic conditions</div>
        <div class="mt-2">{{ patient.allergies|default:"—" }}</div>
      </div>
    </div>

    <!-- VISIT HISTORY -->
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between gap-2 mb-2">
          <div class="fw-bold">Consultation / Visit History</div>
          <a class="btn btn-sm btn-dark"
             style="border-radius:12px; background:var(--brand); border:0;"
             href="{% url 'visits:start_visit' patient.id %}">
            + New Visit
          </a>
        </div>

        {% if visits %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Status</th>
                  <th>Doctor</th>
                  <th>Complaint</th>
                  <th>Diagnosis</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% for v in visits %}
                <tr>
                  <td class="text-muted">
                    {{ v.created_at|date:"M d, Y H:i" }}
                  </td>

                  <td>
                    {% if v.visit_type == "ER" %}
                      <span class="badge text-bg-danger">Emergency</span>
                    {% elif v.visit_type == "FU" %}
                      <span class="badge text-bg-info">Follow-up</span>
                    {% else %}
                      <span class="badge text-bg-secondary">OPD</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if v.status == "CLOSED" %}
                      <span class="badge text-bg-success">Closed</span>
                    {% elif v.status == "IN_CONSULT" %}
                      <span class="badge text-bg-warning">In Consult</span>
                    {% else %}
                      <span class="badge text-bg-secondary">Open</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if v.doctor %}{{ v.doctor }}{% else %}<span class="text-muted">—</span>{% endif %}
                  </td>

                  <td>
                    {% if v.chief_complaint %}
                      {{ v.chief_complaint|truncatechars:35 }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if v.diagnosis_primary %}
                      {{ v.diagnosis_primary|truncatechars:35 }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>

                  <td class="text-end">
                    <div class="d-flex flex-wrap justify-content-end gap-1">

                      <a class="btn btn-sm btn-outline-dark" style="border-radius:12px;"
                         href="{% url 'visits:visit_detail' v.id %}">
                        Open
                      </a>

                      {% if not v.has_vitals %}
                        <a class="btn btn-sm btn-outline-warning" style="border-radius:12px;"
                           href="{% url 'visits:vitals_update' v.id %}">
                          Add Vitals
                        </a>
                      {% else %}
                        <a class="btn btn-sm btn-outline-secondary" style="border-radius:12px;"
                           href="{% url 'visits:vitals_update' v.id %}">
                          Vitals
                        </a>
                      {% endif %}

                      {% if v.status != "CLOSED" %}
                        <a class="btn btn-sm btn-dark" style="border-radius:12px; background:var(--brand); border:0;"
                           href="{% url 'visits:consultation' v.id %}">
                          Consult
                        </a>

                        <a class="btn btn-sm btn-outline-success" style="border-radius:12px;"
                           href="{% url 'visits:close_visit' v.id %}">
                          Close
                        </a>
                      {% endif %}

                      <a class="btn btn-sm btn-outline-primary" style="border-radius:12px;"
                         href="{% url 'visits:emergency_pdf' v.id %}">
                        Emergency PDF
                      </a>

                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-muted small">No consultations/visits recorded yet for this patient.</div>
        {% endif %}
      </div>
    </div>

  </div>
</div>
{% endblock %}
